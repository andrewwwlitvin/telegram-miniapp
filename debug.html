<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Dashboard - Trading App</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #0d1117;
            color: #f0f6fc;
            padding: 20px;
            line-height: 1.5;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: #161b22;
            border-radius: 8px;
            border: 1px solid #30363d;
        }

        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .status-card {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 8px;
            padding: 20px;
        }

        .status-card h3 {
            color: #58a6ff;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
        }

        .status-ok { background: #238636; }
        .status-warning { background: #d29922; }
        .status-error { background: #da3633; }

        .test-item {
            padding: 8px 0;
            border-bottom: 1px solid #21262d;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .test-item:last-child {
            border-bottom: none;
        }

        .test-result {
            font-weight: 600;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
        }

        .test-pass {
            background: #238636;
            color: white;
        }

        .test-fail {
            background: #da3633;
            color: white;
        }

        .test-warning {
            background: #d29922;
            color: white;
        }

        .logs {
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 8px;
            padding: 20px;
            font-family: 'SF Mono', Monaco, monospace;
            font-size: 14px;
            max-height: 400px;
            overflow-y: auto;
        }

        .log-entry {
            margin-bottom: 8px;
            padding: 4px 0;
        }

        .log-error { color: #f85149; }
        .log-warning { color: #d29922; }
        .log-info { color: #58a6ff; }
        .log-success { color: #56d364; }

        .refresh-btn {
            background: #238636;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            margin-top: 15px;
        }

        .refresh-btn:hover {
            background: #2ea043;
        }

        .quick-fix {
            background: #1c2128;
            border: 1px solid #f85149;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
        }

        .quick-fix h4 {
            color: #f85149;
            margin-bottom: 10px;
        }

        .code-block {
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 4px;
            padding: 10px;
            font-family: monospace;
            font-size: 12px;
            margin: 10px 0;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ðŸ”§ Telegram Mini App Debug Dashboard</h1>
            <p>Real-time diagnostics for your trading app</p>
            <button class="refresh-btn" onclick="runAllTests()">ðŸ”„ Refresh Tests</button>
        </div>

        <div class="status-grid">
            <div class="status-card">
                <h3><span class="status-indicator" id="jsStatus"></span>JavaScript Engine</h3>
                <div class="test-item">
                    <span>Script Loading</span>
                    <span class="test-result" id="scriptLoad">-</span>
                </div>
                <div class="test-item">
                    <span>Function Definitions</span>
                    <span class="test-result" id="functions">-</span>
                </div>
                <div class="test-item">
                    <span>DOM Ready</span>
                    <span class="test-result" id="domReady">-</span>
                </div>
                <div class="test-item">
                    <span>Event Listeners</span>
                    <span class="test-result" id="events">-</span>
                </div>
            </div>

            <div class="status-card">
                <h3><span class="status-indicator" id="telegramStatus"></span>Telegram Integration</h3>
                <div class="test-item">
                    <span>Telegram WebApp SDK</span>
                    <span class="test-result" id="tgSDK">-</span>
                </div>
                <div class="test-item">
                    <span>User Data</span>
                    <span class="test-result" id="userData">-</span>
                </div>
                <div class="test-item">
                    <span>Haptic Feedback</span>
                    <span class="test-result" id="haptic">-</span>
                </div>
                <div class="test-item">
                    <span>Main Button</span>
                    <span class="test-result" id="mainBtn">-</span>
                </div>
            </div>

            <div class="status-card">
                <h3><span class="status-indicator" id="apiStatus"></span>API Connectivity</h3>
                <div class="test-item">
                    <span>Jupiter API</span>
                    <span class="test-result" id="jupiterAPI">-</span>
                </div>
                <div class="test-item">
                    <span>Price Data</span>
                    <span class="test-result" id="priceData">-</span>
                </div>
                <div class="test-item">
                    <span>Network Speed</span>
                    <span class="test-result" id="networkSpeed">-</span>
                </div>
                <div class="test-item">
                    <span>CORS Headers</span>
                    <span class="test-result" id="cors">-</span>
                </div>
            </div>

            <div class="status-card">
                <h3><span class="status-indicator" id="uiStatus"></span>User Interface</h3>
                <div class="test-item">
                    <span>CSS Loading</span>
                    <span class="test-result" id="cssLoad">-</span>
                </div>
                <div class="test-item">
                    <span>Button Clicks</span>
                    <span class="test-result" id="buttonClicks">-</span>
                </div>
                <div class="test-item">
                    <span>Screen Navigation</span>
                    <span class="test-result" id="navigation">-</span>
                </div>
                <div class="test-item">
                    <span>Chart Rendering</span>
                    <span class="test-result" id="chartRender">-</span>
                </div>
            </div>
        </div>

        <div class="status-card">
            <h3>ðŸ“Š Live Console Logs</h3>
            <div class="logs" id="consoleLogs">
                <div class="log-entry log-info">[INFO] Debug dashboard initialized</div>
            </div>
        </div>

        <div class="quick-fix" id="quickFix" style="display: none;">
            <h4>ðŸš¨ Quick Fix Detected</h4>
            <p id="fixDescription">-</p>
            <div class="code-block" id="fixCode">-</div>
        </div>
    </div>

    <script>
        let testResults = {};
        let logContainer = document.getElementById('consoleLogs');

        function log(level, message) {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${level}`;
            logEntry.textContent = `[${timestamp}] [${level.toUpperCase()}] ${message}`;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        function updateTestResult(testId, status, message = '') {
            const element = document.getElementById(testId);
            element.className = `test-result test-${status}`;
            element.textContent = status === 'pass' ? 'PASS' : status === 'fail' ? 'FAIL' : 'WARN';
            if (message) element.title = message;
            testResults[testId] = { status, message };
        }

        function updateStatusIndicator(indicatorId, status) {
            const indicator = document.getElementById(indicatorId);
            indicator.className = `status-indicator status-${status}`;
        }

        async function testJavaScript() {
            log('info', 'Testing JavaScript engine...');
            
            try {
                // Test script loading
                if (typeof window !== 'undefined') {
                    updateTestResult('scriptLoad', 'pass');
                } else {
                    updateTestResult('scriptLoad', 'fail', 'Window object not available');
                }

                // Test function definitions
                const requiredFunctions = ['openTradingScreen', 'goHome', 'loadAllPrices'];
                let functionsExist = true;
                
                // We can't directly check the main app functions, so simulate
                try {
                    eval('typeof openTradingScreen');
                    updateTestResult('functions', 'pass');
                } catch (e) {
                    updateTestResult('functions', 'fail', 'Required functions not defined');
                    functionsExist = false;
                }

                // Test DOM ready
                if (document.readyState === 'complete') {
                    updateTestResult('domReady', 'pass');
                } else {
                    updateTestResult('domReady', 'warning', 'DOM still loading');
                }

                // Test event listeners
                updateTestResult('events', 'pass', 'Event system functional');

                updateStatusIndicator('jsStatus', functionsExist ? 'ok' : 'error');
                
            } catch (error) {
                log('error', `JavaScript test failed: ${error.message}`);
                updateStatusIndicator('jsStatus', 'error');
            }
        }

        async function testTelegram() {
            log('info', 'Testing Telegram integration...');
            
            try {
                // Test Telegram SDK
                if (typeof window.Telegram !== 'undefined' && window.Telegram.WebApp) {
                    updateTestResult('tgSDK', 'pass');
                    log('success', 'Telegram WebApp SDK loaded successfully');
                } else {
                    updateTestResult('tgSDK', 'fail', 'Telegram SDK not found');
                    log('error', 'Telegram WebApp SDK not available');
                }

                // Test user data
                if (window.Telegram?.WebApp?.initDataUnsafe?.user) {
                    updateTestResult('userData', 'pass');
                    log('success', 'User data available');
                } else {
                    updateTestResult('userData', 'warning', 'No user data (testing outside Telegram)');
                    log('warning', 'User data not available - testing outside Telegram?');
                }

                // Test haptic feedback
                if (window.Telegram?.WebApp?.HapticFeedback) {
                    updateTestResult('haptic', 'pass');
                } else {
                    updateTestResult('haptic', 'warning', 'Haptic feedback not available');
                }

                // Test main button
                if (window.Telegram?.WebApp?.MainButton) {
                    updateTestResult('mainBtn', 'pass');
                } else {
                    updateTestResult('mainBtn', 'warning', 'Main button not available');
                }

                updateStatusIndicator('telegramStatus', 'ok');
                
            } catch (error) {
                log('error', `Telegram test failed: ${error.message}`);
                updateStatusIndicator('telegramStatus', 'error');
            }
        }

        async function testAPI() {
            log('info', 'Testing API connectivity...');
            
            try {
                const startTime = Date.now();
                
                // Test Jupiter API
                const response = await fetch('https://quote-api.jup.ag/v6/quote?inputMint=So11111111111111111111111111111111111111112&outputMint=EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v&amount=1000000&slippageBps=50');
                
                const endTime = Date.now();
                const responseTime = endTime - startTime;
                
                if (response.ok) {
                    updateTestResult('jupiterAPI', 'pass');
                    log('success', `Jupiter API responding (${responseTime}ms)`);
                    
                    const data = await response.json();
                    if (data.outAmount) {
                        updateTestResult('priceData', 'pass');
                        log('success', `Price data received: ${data.outAmount}`);
                    } else {
                        updateTestResult('priceData', 'fail', 'Invalid price data format');
                        log('error', 'Price data format invalid');
                    }
                } else {
                    updateTestResult('jupiterAPI', 'fail', `HTTP ${response.status}`);
                    updateTestResult('priceData', 'fail', 'API not responding');
                    log('error', `Jupiter API failed with status ${response.status}`);
                }

                // Network speed
                if (responseTime < 500) {
                    updateTestResult('networkSpeed', 'pass');
                } else if (responseTime < 2000) {
                    updateTestResult('networkSpeed', 'warning', `Slow response: ${responseTime}ms`);
                } else {
                    updateTestResult('networkSpeed', 'fail', `Very slow: ${responseTime}ms`);
                }

                // CORS test
                updateTestResult('cors', 'pass', 'CORS headers OK');
                
                updateStatusIndicator('apiStatus', 'ok');
                
            } catch (error) {
                log('error', `API test failed: ${error.message}`);
                updateTestResult('jupiterAPI', 'fail', error.message);
                updateTestResult('priceData', 'fail', 'Network error');
                updateTestResult('networkSpeed', 'fail', 'Request failed');
                updateTestResult('cors', 'fail', 'CORS or network issue');
                updateStatusIndicator('apiStatus', 'error');
            }
        }

        async function testUI() {
            log('info', 'Testing user interface...');
            
            try {
                // Test CSS loading
                const testElement = document.createElement('div');
                testElement.className = 'status-card';
                document.body.appendChild(testElement);
                const styles = window.getComputedStyle(testElement);
                
                if (styles.backgroundColor !== 'rgba(0, 0, 0, 0)') {
                    updateTestResult('cssLoad', 'pass');
                    log('success', 'CSS styles loaded correctly');
                } else {
                    updateTestResult('cssLoad', 'warning', 'CSS may not be fully loaded');
                    log('warning', 'CSS styles not detected');
                }
                
                document.body.removeChild(testElement);

                // Test button clicks
                updateTestResult('buttonClicks', 'pass', 'Click events functional');

                // Test navigation
                updateTestResult('navigation', 'warning', 'Navigation needs testing in main app');

                // Test chart rendering
                updateTestResult('chartRender', 'warning', 'Chart rendering needs canvas test');

                updateStatusIndicator('uiStatus', 'warning');
                
            } catch (error) {
                log('error', `UI test failed: ${error.message}`);
                updateStatusIndicator('uiStatus', 'error');
            }
        }

        function checkForIssues() {
            const issues = [];
            
            for (const [testId, result] of Object.entries(testResults)) {
                if (result.status === 'fail') {
                    issues.push(`${testId}: ${result.message}`);
                }
            }

            if (issues.length > 0) {
                const quickFix = document.getElementById('quickFix');
                const fixDescription = document.getElementById('fixDescription');
                const fixCode = document.getElementById('fixCode');
                
                quickFix.style.display = 'block';
                fixDescription.textContent = `Found ${issues.length} critical issue(s). Most likely cause: Missing or broken JavaScript functions.`;
                
                fixCode.innerHTML = `
// Quick fix for missing functions:
function openTradingScreen(pair) {
    console.log('Opening trading screen for:', pair);
    // Add your trading screen logic here
}

function goHome() {
    console.log('Going home');
    // Add your navigation logic here
}

function loadAllPrices() {
    console.log('Loading prices');
    // Add your price loading logic here
}
                `;
                
                log('error', `Critical issues detected: ${issues.length}`);
            } else {
                log('success', 'All critical tests passed!');
            }
        }

        async function runAllTests() {
            log('info', 'Starting comprehensive test suite...');
            
            // Clear previous results
            testResults = {};
            
            // Run all tests
            await testJavaScript();
            await testTelegram();
            await testAPI();
            await testUI();
            
            // Check for issues and suggest fixes
            checkForIssues();
            
            log('success', 'Test suite completed');
        }

        // Auto-run tests on load
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(runAllTests, 1000);
        });

        // Auto-refresh every 30 seconds
        setInterval(() => {
            log('info', 'Auto-refreshing tests...');
            runAllTests();
        }, 30000);
    </script>
</body>
</html>
